name: ci-run-docs

on:
  push:
    branches: [ main ]
    tags:     [ "v*.*.*" ]
  pull_request:
    paths:
      - 'docs/**'
      - '.github/workflows/docs.yaml'
  workflow_dispatch:
    inputs:
      ref:
        description: "Branch, tag or commit to deploy the docs. If empty, use the ref that triggered the workflow."
        required: false
        default: ""
      version:
        type: string
        description: "Version of the documentation to deploy"
        required: false
        default: "latest"

permissions:
  contents: write
  pages:    write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

env:
  DOCS_ROOT: docs
  DOCS_SRC:  docs/src
  ENABLE_TESTS: false

jobs:
  build-docs:
    name: build-docs ðŸ“˜
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: ${{ inputs.ref || '' }}

      - name: Extract version from tag
        if: startsWith(github.ref, 'refs/tags/')
        id: version
        shell: bash -e {0}
        run: |
          echo "value=${GITHUB_REF_NAME#*-}" >> "$GITHUB_OUTPUT"

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@1780873c7b576612439a134613cc4cc74ce5538c # v1.15.2

      - name: Install mdbook-yapp
        run: cargo install mdbook-yapp --locked

      - name: Deploy mdBook to gh-pages
        uses: matter-labs/deploy-mdbooks@c72ae3825faeb7d20cbf3e67714f7253dd0ee7cb
        with: 
          version:      ${{ inputs.version || steps.version.outputs.value || github.ref_name }}
          docs-dir:     ${{ env.DOCS_ROOT }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          enable-tests: ${{ env.ENABLE_TESTS }}
          deploy:       ${{ github.event_name != 'pull_request' }}